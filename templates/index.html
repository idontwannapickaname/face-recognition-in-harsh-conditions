<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Nh·∫≠n Di·ªán Khu√¥n M·∫∑t</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1>H·ªá Th·ªëng Nh·∫≠n Di·ªán Khu√¥n M·∫∑t</h1>
            <p>ƒêƒÉng k√Ω, thu th·∫≠p d·ªØ li·ªáu v√† nh·∫≠n di·ªán khu√¥n m·∫∑t v·ªõi ƒë·ªô ch√≠nh x√°c cao.</p>
        </header>

        <main class="grid-container">
            <!-- C·ªôt b√™n tr√°i: ƒêƒÉng k√Ω & Danh s√°ch -->
            <div class="grid-item">
                <section class="card">
                    <h2><span class="icon">üë§</span>ƒêƒÉng K√Ω Ng∆∞·ªùi D√πng</h2>
                    <div class="tab-group">
                        <button id="tab-webcam" class="tab-btn active" type="button">D√πng Webcam</button>
                        <button id="tab-upload" class="tab-btn" type="button">Upload ·∫¢nh</button>
                    </div>

                    <!-- Tab Thu th·∫≠p qua Webcam -->
                    <div id="webcam-section">
                        <div class="form-group">
                            <label for="webcam-name">T√™n ng∆∞·ªùi d√πng:</label>
                            <input type="text" id="webcam-name" required placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n ·ªü ƒë√¢y">
                        </div>
                        <div class="form-group">
                            <label>Camera Thu Th·∫≠p D·ªØ Li·ªáu:</label>
                            <div class="camera-container">
                                <video id="collect-video" autoplay muted playsinline>Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£.</video>
                                <div id="collect-progress" class="result-box">B·∫•m "B·∫Øt ƒë·∫ßu" ƒë·ªÉ thu th·∫≠p</div>
                            </div>
                        </div>
                        <div class="controls">
                            <button id="start-collect-btn" class="btn btn-primary" type="button">B·∫Øt ƒë·∫ßu</button>
                            <button id="stop-collect-btn" class="btn btn-danger" type="button" style="display:none;">D·ª´ng</button>
                        </div>
                         <small>H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ch·ª•p {{ max_collect }} ·∫£nh khi ph√°t hi·ªán c√≥ khu√¥n m·∫∑t.</small>
                    </div>

                    <!-- Tab Upload ·∫£nh -->
                    <div id="upload-section" style="display:none;">
                        <form action="{{ url_for('register') }}" method="post" enctype="multipart/form-data" id="upload-form">
                            <div class="form-group">
                                <label for="upload-name">T√™n ng∆∞·ªùi d√πng:</label>
                                <input type="text" id="upload-name" name="name" required placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n ·ªü ƒë√¢y">
                            </div>
                            <div class="form-group">
                                <label for="images">Ch·ªçn ·∫£nh khu√¥n m·∫∑t:</label>
                                <input type="file" id="images" name="images" multiple required accept="image/jpeg, image/png, image/jpg">
                                <small>Ch·ªçn nhi·ªÅu ·∫£nh ƒë·ªÉ c√≥ k·∫øt qu·∫£ t·ªët nh·∫•t. M·ªói ·∫£nh ch·ªâ n√™n c√≥ m·ªôt khu√¥n m·∫∑t.</small>
                            </div>
                            <button type="submit" class="btn btn-primary">T·∫£i l√™n v√† Training</button>
                        </form>
                    </div>
                </section>

                <section class="card">
                    <h2><span class="icon">üë•</span>Danh S√°ch Ng∆∞·ªùi D√πng</h2>
                    <div class="user-list">
                        {% if users %}
                            <table>
                                <tbody>
                                {% for user in users %}
                                    <tr>
                                        <td>{{ user.name }}</td>
                                        <td>
                                            <form action="{{ url_for('delete_user', user_id=user.id) }}" method="post" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a vƒ©nh vi·ªÖn ng∆∞·ªùi d√πng {{ user.name }} v√† to√†n b·ªô d·ªØ li·ªáu?');">
                                                <button type="submit" class="btn btn-danger btn-sm">X√≥a</button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p>Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o trong h·ªá th·ªëng.</p>
                        {% endif %}
                    </div>
                </section>
            </div>

            <!-- C·ªôt b√™n ph·∫£i: Nh·∫≠n di·ªán -->
            <div class="grid-item">
                <section class="card">
                    <h2><span class="icon">üì∑</span>Nh·∫≠n Di·ªán Real-time</h2>
                    <div class="camera-container">
                        <video id="recognize-video" autoplay muted playsinline></video>
                        <div id="result-box" class="result-box">
                            <p id="result-text">ƒêang kh·ªüi ƒë·ªông camera...</p>
                        </div>
                    </div>
                    <div class="controls">
                        <button id="recognize-btn" class="btn btn-secondary">Nh·∫≠n Di·ªán</button>
                    </div>
                </section>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // === DOM Elements ===
    const tabWebcam = document.getElementById('tab-webcam');
    const tabUpload = document.getElementById('tab-upload');
    const webcamSection = document.getElementById('webcam-section');
    const uploadSection = document.getElementById('upload-section');
    const collectVideo = document.getElementById('collect-video');
    const startCollectBtn = document.getElementById('start-collect-btn');
    const stopCollectBtn = document.getElementById('stop-collect-btn');
    const collectProgress = document.getElementById('collect-progress');
    const recognizeVideo = document.getElementById('recognize-video');
    const recognizeBtn = document.getElementById('recognize-btn');
    const resultBox = document.getElementById('result-box');
    const resultText = document.getElementById('result-text');

    // === State Variables ===
    const MAX_COLLECT_IMAGES = parseInt("{{ max_collect }}", 10);
    let collectStream = null;
    let recognizeStream = null;
    let isCollecting = false;
    let collectInterval = null;

    // === Core Functions ===
    function switchTab(showWebcam) {
        tabWebcam.classList.toggle('active', showWebcam);
        webcamSection.style.display = showWebcam ? 'block' : 'none';
        tabUpload.classList.toggle('active', !showWebcam);
        uploadSection.style.display = showWebcam ? 'none' : 'block';

        if (showWebcam) {
            startWebcam(collectVideo, (stream) => { collectStream = stream; });
        } else {
            stopWebcam(collectStream, collectVideo);
        }
    }

    async function startWebcam(videoElement, streamHandler) {
        if (videoElement.srcObject) return true; // Already running
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            videoElement.srcObject = stream;
            if (streamHandler) streamHandler(stream);
            return true;
        } catch (err) {
            console.error(`Webcam error for ${videoElement.id}:`, err);
            return false;
        }
    }

    function stopWebcam(stream, videoElement) {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        videoElement.srcObject = null;
    }

    // === Data Collection Logic ===
    startCollectBtn.addEventListener('click', () => {
        const nameInput = document.getElementById('webcam-name');
        if (!nameInput.value.trim()) {
            alert('Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi d√πng.');
            nameInput.focus();
            return;
        }
        isCollecting = true;
        let collectedCount = 0;
        
        startCollectBtn.style.display = 'none';
        stopCollectBtn.style.display = 'inline-block';
        collectProgress.className = 'result-box processing';
        collectProgress.textContent = `ƒê√£ ch·ª•p: 0/${MAX_COLLECT_IMAGES}`;

        collectInterval = setInterval(() => {
            if (!isCollecting || collectedCount >= MAX_COLLECT_IMAGES) {
                finishCollection(collectedCount >= MAX_COLLECT_IMAGES);
                return;
            }
            captureAndSend(nameInput.value.trim(), (success) => {
                if (success) {
                    collectedCount++;
                    collectProgress.textContent = `ƒê√£ ch·ª•p: ${collectedCount}/${MAX_COLLECT_IMAGES}`;
                    if (collectedCount >= MAX_COLLECT_IMAGES) {
                        finishCollection(true);
                    }
                }
            });
        }, 500);
    });

    stopCollectBtn.addEventListener('click', () => finishCollection(false));

    function finishCollection(isComplete) {
        isCollecting = false;
        clearInterval(collectInterval);
        startCollectBtn.style.display = 'inline-block';
        stopCollectBtn.style.display = 'none';
        
        if (isComplete) {
            collectProgress.textContent = 'Ho√†n t·∫•t! ƒêang training...';
            collectProgress.className = 'result-box success';
            const finalForm = new FormData();
            finalForm.append('name', document.getElementById('webcam-name').value.trim());
            fetch('/register', { method: 'POST', body: finalForm })
                .then(response => {
                    if (response.ok) {
                        alert('ƒêƒÉng k√Ω v√† training th√†nh c√¥ng! Trang s·∫Ω ƒë∆∞·ª£c t·∫£i l·∫°i.');
                        window.location.reload();
                    } else {
                        alert('L·ªói trong qu√° tr√¨nh training cu·ªëi c√πng.');
                        collectProgress.className = 'result-box error';
                    }
                });
        } else {
            collectProgress.textContent = 'ƒê√£ d·ª´ng thu th·∫≠p.';
            collectProgress.className = 'result-box';
        }
    }
    
    function captureAndSend(name, callback) {
        const canvas = document.createElement('canvas');
        canvas.width = collectVideo.videoWidth;
        canvas.height = collectVideo.videoHeight;
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        ctx.drawImage(collectVideo, 0, 0);

        canvas.toBlob(async (blob) => {
            if (!blob) return;
            const formData = new FormData();
            formData.append('name', name);
            formData.append('image', blob, 'webcam_capture.jpg');
            try {
                const response = await fetch('/collect_webcam_image', { method: 'POST', body: formData });
                const data = await response.json();
                callback(data.status === 'ok');
            } catch (error) {
                console.error('L·ªói g·ª≠i ·∫£nh:', error);
                callback(false);
            }
        }, 'image/jpeg');
    }

    // === Recognition Logic ===
    recognizeBtn.addEventListener('click', async () => {
        if (!recognizeStream || recognizeVideo.paused) {
            alert('Camera nh·∫≠n di·ªán ch∆∞a s·∫µn s√†ng.');
            return;
        }
        recognizeBtn.disabled = true;
        resultText.textContent = 'ƒêang x·ª≠ l√Ω...';
        resultBox.className = 'result-box processing';

        const canvas = document.createElement('canvas');
        canvas.width = recognizeVideo.videoWidth;
        canvas.height = recognizeVideo.videoHeight;
        canvas.getContext('2d').drawImage(recognizeVideo, 0, 0);

        canvas.toBlob(async (blob) => {
            const formData = new FormData();
            formData.append('image', blob, 'rec_img.jpg');
            try {
                const response = await fetch('/recognize', { method: 'POST', body: formData });
                const data = await response.json();
                updateResult(data);
            } catch (error) {
                updateResult({ status: 'error', message: 'L·ªói k·∫øt n·ªëi' });
            } finally {
                recognizeBtn.disabled = false;
            }
        }, 'image/jpeg');
    });

    function updateResult(data) {
        switch (data.status) {
            case 'success':
                resultText.innerHTML = `Ch√†o, <strong>${data.user.name}</strong> <small>(~${data.distance})</small>`;
                resultBox.className = 'result-box success';
                break;
            case 'unknown':
                resultText.innerHTML = `<strong>Ng∆∞·ªùi l·∫°</strong> <small>(~${data.distance || 'N/A'})</small>`;
                resultBox.className = 'result-box not-found';
                break;
            case 'no_face':
                resultText.textContent = 'Kh√¥ng t√¨m th·∫•y khu√¥n m·∫∑t.';
                resultBox.className = 'result-box';
                break;
            default:
                resultText.textContent = `L·ªói: ${data.message || 'Kh√¥ng x√°c ƒë·ªãnh'}`;
                resultBox.className = 'result-box error';
        }
    }

    // === App Initialization ===
    async function initializeApp() {
        const recCamStarted = await startWebcam(recognizeVideo, (stream) => { recognizeStream = stream; });
        if (recCamStarted) {
            resultText.textContent = 'S·∫µn s√†ng. Nh·∫•n "Nh·∫≠n Di·ªán".';
            resultBox.className = 'result-box';
            recognizeBtn.disabled = false;
        } else {
            resultText.textContent = 'L·ªói camera nh·∫≠n di·ªán.';
            resultBox.className = 'result-box error';
            recognizeBtn.disabled = true;
        }
        switchTab(true);
    }

    initializeApp();
});
</script>
</body>
</html> 